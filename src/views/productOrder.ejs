<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Order Form</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
        integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <!-- Load custom Javascript and CSS -->
    <link rel="stylesheet" href="/css/style_product_oder.css">
    <script>
        const facebookAppId = "873864850346412";
    </script>
    <script type="text/javascript" src="/js/order.js"></script>
</head>

<body>

    <!-- Load Facebook Messenger Extensions -->
    <script>
        window.fbMessengerPlugins = window.fbMessengerPlugins || {
            init: function () {
                FB.init({
                    appId: facebookAppId,
                    autoLogAppEvents: true,
                    xfbml: true,
                    version: 'v2.10'
                });
            },
            callable: []
        };

        window.fbAsyncInit = window.fbAsyncInit || function () {
            window.fbMessengerPlugins.callable.forEach(function (item) {
                item();
            });
            window.fbMessengerPlugins.init();
        };
        setTimeout(function () {
            (function (d, s, id) {
                var js, fjs = d.getElementsByTagName(s)[0];
                if (d.getElementById(id)) {
                    return;
                }
                js = d.createElement(s);
                js.id = id;
                js.src = "//connect.facebook.net/en_US/sdk.js";
                fjs.parentNode.insertBefore(js, fjs);
            }(document, 'script', 'facebook-jssdk'));
        }, 0);
    </script>

    <h1>Product Order Form</h1>
<!-- Your HTML Form -->
<h1>Product Order Form</h1>
<form id="order_form" action="/post-order-form" method="post">
    
    <!-- User Information -->
    <input type="text" id="psid" name="psid" hidden>

    <!-- Additional form fields for product information -->
    <input type="text" id="product" name="product" hidden>
    <input type="text" id="size" name="size" hidden>
    <input type="text" id="price" name="price" hidden>

    <label for="email">Email:</label>
    <input type="email" id="email" name="email" required>

    <label for="nom">Nom et prénom:</label>
    <input type="nom" id="nom" name="nom" required>

    <label for="adresse">Adresse:</label>
    <input type="adresse" id="adresse" name="adresse" required>

    <label for="numéro_t">Numéro de téléphone:</label>
    <input type="numéro_t" id="numéro_t" name="numéro_t" required>

    <!-- Submit Button -->
    <button type="button" onclick="submitOrder()">Submit Order</button>
</form>
<script src="/src/services/templateMessage.js"></script>

<!-- JavaScript Code -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const urlParams = new URLSearchParams(window.location.search);
        // Pre-fill product name
    
        // Attach handler to Order now buttons
        const orderButtons = document.querySelectorAll('.template-element button.order-now');
        orderButtons.forEach(button => {
            button.addEventListener('click', (event) => {
                event.preventDefault(); // Prevent default form submission
                handleOrderNowClick(button.parentElement);
            });
        });
    });
    
    function handleOrderNowClick(element) {
        // Get title and subtitle from template element
        const title = element.querySelector('h2').innerText;
        const subtitle = element.querySelector('.subtitle').innerText;
    
        // Split subtitle into size and price
        const subtitleParts = subtitle.split('\n');
        const size = subtitleParts[0];
        const price = subtitleParts[1];
    
        // Populate form fields
        document.getElementById('product').value = title;
        document.getElementById('size').value = size;
        document.getElementById('price').value = price;
    
        // Trigger the form submission manually
        submitOrder();
    }
    function submitOrder() {
        // Collect form data
        const formData = {
            psid: document.getElementById('psid').value,
            email: document.getElementById('email').value,
            nom: document.getElementById('nom').value,
            adresse: document.getElementById('adresse').value,
            numéro_t: document.getElementById('numéro_t').value,
            product: document.getElementById('product').value,
            size: document.getElementById('size').value,
            price: document.getElementById('price').value
        };

        // Call the function from the external file to generate the sendRecipient template with the collected data
        const recipientTemplate = sendRecipient(formData);

        // Assuming there is a function to send the template to the user, replace it with your actual function
        // sendTemplateToUser(recipientTemplate);
        console.log(recipientTemplate);
    }

    
    
</script>

    
    <script>
        window.extAsyncInit = async function () {
            console.log('Messenger extensions are ready');

            try {
                const thread_context = await new Promise((resolve, reject) => {
                    MessengerExtensions.getContext(facebookAppId,
                        function success(thread_context) {
                            resolve(thread_context);
                        },
                        function error(err) {
                            reject(err);
                        }
                    );
                });

                console.log(thread_context);
                const userPSID = thread_context.psid;
                document.getElementById("psid").value = userPSID;

                $("#order_form").submit(async function (event) {
                    event.preventDefault();
                    const data = {
                        psid: userPSID,
                        name: $("#name").val(),
                        email: $("#email").val(),
                        product: $("#product").val(),
                        quantity: $("#quantity").val(),
                        comments: $("#comments").val()
                    };

                    try {
                        await $.post(`${window.location.origin}/set-product-order`, data);
                        MessengerExtensions.requestCloseBrowser(function () {
                            console.log('Window will be closed');
                        }, function (error) {
                            console.log('There is an error');
                            console.log(error);
                        });
                    } catch (error) {
                        console.error('Error submitting data:', error);
                    }
                });

            } catch (error) {
                console.error('Error initializing Messenger extensions:', error);
            }
        }
    </script>
</body>

</html>
